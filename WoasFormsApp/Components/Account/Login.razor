@page "/Account/Login"

@inject SignInManager<WoasFormsAppUser> SignInManager
@inject AuthenticationStateProvider asp
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject ISnackbar SnackBar

<PageTitle>Login</PageTitle>

<MudGrid Class="m-6" Justify="Justify.Center"> 
    <MudItem md="6">
        <StatusMessage Message="@errorMessage" />
        <EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
            <DataAnnotationsValidator />

            <MudText Align="Align.Center" GutterBottom="true" Typo="Typo.h2">Log in</MudText>

            <MudGrid>
                <MudItem md="12">
                    <MudStaticTextField For="@(() => Input.Username)" @bind-Value="Input.Username"
                    Label="User name"
                    UserAttributes="@(new() { { "autocomplete", "username" }, { "aria-required", "true" } } )" />
                </MudItem>
                <MudItem md="12">
                    <MudStaticTextField For="@(() => Input.Password)" @bind-Value="Input.Password" 
                    Label="Password" InputType="InputType.Password"  
                    UserAttributes="@(new() { { "autocomplete", "current-password" }, { "aria-required", "true" } } )" />
                </MudItem>
                <MudItem md="12">
                    <MudStaticCheckBox For="@(() => Input.RememberMe)" @bind-Value="Input.RememberMe">Remember me</MudStaticCheckBox>
                </MudItem>
                <MudItem md="12">
                    <MudStaticButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" FormAction="FormAction.Submit">Log in</MudStaticButton>
                </MudItem>
            </MudGrid>
        </EditForm>

        <MudGrid Class="mt-4">
            <MudItem md="12">
                @* <MudLink Href="Account/ForgotPassword">Forgot your password?</MudLink><br /> *@
                <MudLink Href="/Account/Register">Don't have an account? Click to register.</MudLink>
                @* <MudLink Href="Account/ResendEmailConfirmation">Resend email confirmation</MudLink> *@
            </MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>



@code {
    private string? errorMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private LoginViewModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var user = (await asp.GetAuthenticationStateAsync()).User;

        if (user.Identity.IsAuthenticated)
        {
            await SignInManager.SignOutAsync();
            NavigationManager.Refresh(forceReload: true);
        }
    }

    public async Task LoginUser()
    {
        var result = await SignInManager.PasswordSignInAsync(Input.Username, Input.Password, Input.RememberMe, lockoutOnFailure: false);
        if (result.Succeeded)
        {
            Logger.LogInformation("User logged in.");
            NavigationManager.NavigateTo("/", forceLoad: true);
        }
        else
        {
            SnackBar.Add("Login failed", Severity.Error);
            errorMessage = "Error: Invalid login attempt.";
        }
    }

    private sealed class LoginViewModel
    {

        public string Username { get; set; } = "";

        public string Password { get; set; } = "";

        public bool RememberMe { get; set; } = true;

    }
}